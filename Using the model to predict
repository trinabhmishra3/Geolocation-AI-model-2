import pathlib
import numpy as np
from keras.models import load_model
from keras.preprocessing import image
import os
from PIL import Image

model_path = r"C:\Users\Eigenaar\PycharmProjects\pythonProject\geoguessr_model_pws.keras"
dataset_path = r"C:\Users\Eigenaar\Downloads\bewerkt_geo"
TEST_IMAGES_DIR = r"C:\Users\Eigenaar\Downloads\TestFotos"

model = load_model(model_path)

geo_data_dir = pathlib.Path(dataset_path)
class_names = sorted([d.name for d in geo_data_dir.iterdir() if d.is_dir()])

def crop_foto(img):
    w, h = img.size
    left = int(w * 0.10)
    right = int(w * 0.78)
    top = 0
    bottom = h
    return img.crop((left, top, right, bottom))
def predict_image(model, img_path, class_names):
    img_pil = Image.open(img_path)
    img_cropped = crop_foto(img_pil)
    img = img_cropped.resize((224, 224))
    img_array = image.img_to_array(img)
    img_array = np.expand_dims(img_array, axis=0)

    predictions = model.predict(img_array)[0]
    print(f" Afbeelding: {os.path.basename(img_path)}")
    top3 = predictions.argsort()[-3:][::-1]
    for i in top3:
        print(f" {class_names[i]}: {predictions[i]:.2f}")

    predicted_class = class_names[np.argmax(predictions)]
    confidence = np.max(predictions)
    return predicted_class, confidence

test_images_dir = pathlib.Path(TEST_IMAGES_DIR)

for img_file in test_images_dir.glob('*'):
    if img_file.suffix.lower() in ['.jpg', '.jpeg', '.png']:
        predict_image(model, str(img_file), class_names)
